---
layout:     post
title:      ğŸ”ã€Œå‰–æJWTã€ ä¹‹ æ•´åˆéå¯¹ç§°åŠ å¯†
subtitle:   jwtæ€ç»´å¯¼å›¾ï¼Œè®©jwtä¸å†éš¾æ‡‚
date:       2018-11-23
author:     BY
header-img: img/post-bg-github-cup.jpg
catalog: true
tags:
    - JWT
---

> æ­£æ‰€è°“å‰äººæ ½æ ‘ï¼Œåäººä¹˜å‡‰ã€‚
> 
> æ„Ÿè°¢ buxiaoxiaï¼ˆåŸåˆ›ï¼‰

# å‰è¨€

é˜…è¯»æ­¤æ–‡ï¼Œå¸Œæœ›æ˜¯å¯¹JWTä»¥åŠOAuth2æœ‰ä¸€å®šäº†è§£çš„ç«¥é‹ã€‚

JWTè®¤è¯ï¼Œæä¾›äº†å¯¹ç§°åŠ å¯†ä»¥åŠéå¯¹ç§°çš„å®ç°ã€‚

# Spring Boot,Spring Securityå®ç°OAuth2 + JWTè®¤è¯

### è®¤è¯æœåŠ¡ç«¯

æä¾›è®¤è¯ã€æˆæƒæœåŠ¡

å®ç°æ–¹å¼ï¼Œä¸»è¦å¤å†™AuthorizationServerConfigurerAdapterå®ç°

### è®¤è¯æœåŠ¡1-å¯¹ç§°åŠ å¯†æ–¹å¼

å¯¹ç§°åŠ å¯†ï¼Œè¡¨ç¤ºè®¤è¯æœåŠ¡ç«¯å’Œè®¤è¯å®¢æˆ·ç«¯çš„å…±ç”¨ä¸€ä¸ªå¯†é’¥

#### å®ç°æ–¹å¼

- AccessTokenè½¬æ¢å™¨-å®šä¹‰tokençš„ç”Ÿæˆæ–¹å¼ï¼Œè¿™é‡Œä½¿ç”¨JWTç”Ÿæˆtokenï¼Œå¯¹ç§°åŠ å¯†åªéœ€è¦åŠ å…¥keyç­‰å…¶ä»–ä¿¡æ¯ï¼ˆè‡ªå®šä¹‰ï¼‰ã€‚

` @Bean
           public JwtAccessTokenConverter accessTokenConverter() {
               JwtAccessTokenConverter converter = new JwtAccessTokenConverter();
               converter.setSigningKey("123");
               return converter;
           }`

- å‘Šè¯‰spring security tokençš„ç”Ÿæˆæ–¹å¼

`@Override
             public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
                 endpoints.tokenStore(tokenStore())
                          .accessTokenConverter(accessTokenConverter())
                          .authenticationManager(authenticationManager);
             }`

ä»¥ä¸Šå¯¹ç§°åŠ å¯†çš„JWTæ–¹å¼çš„è®¤è¯æœåŠ¡ç«¯å°±OKäº†ï¼Œåé¢æœ‰å¯¹åº”çš„èµ„æºæœåŠ¡ç«¯çš„å†…å®¹ã€‚

### è®¤è¯æœåŠ¡2-éå¯¹ç§°åŠ å¯†æ–¹å¼ï¼ˆå…¬é’¥å¯†é’¥ï¼‰

æœåŠ¡ç«¯ç”Ÿæˆå…¬é’¥å’Œå¯†é’¥ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯ä½¿ç”¨è·å–åˆ°çš„å…¬é’¥åˆ°æœåŠ¡å™¨åšè®¤è¯ã€‚ 
å› æ­¤é¦–å…ˆè¦ç”Ÿæˆä¸€ä¸ªè¯ä¹¦ï¼Œå¯¼å‡ºå…¬é’¥å†åç»­æ­¥éª¤

#### å®ç°æ–¹å¼

- ç”ŸæˆJKSæ–‡ä»¶

`keytool -genkeypair -alias mytest -keyalg RSA -keypass mypass -keystore mytest.jks -storepass mypass`

å…·ä½“å‚æ•°çš„æ„æ€ä¸å¦è¯´æ˜ã€‚

- å¯¼å‡ºå…¬é’¥

`keytool -list -rfc --keystore mytest.jks | openssl x509 -inform pem -pubkey`

- ç”Ÿæˆå…¬é’¥æ–‡æœ¬

`-----BEGIN PUBLIC KEY-----
 MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAhAF1qpL+8On3rF2M77lR
 +l3WXKpGXIc2SwIXHwQvml/4SG7fJcupYVOkiaXj4f8g1e7qQCU4VJGvC/gGJ7sW
 fn+L+QKVaRhs9HuLsTzHcTVl2h5BeawzZoOi+bzQncLclhoMYXQJJ5fULnadRbKN
 HO7WyvrvYCANhCmdDKsDMDKxHTV9ViCIDpbyvdtjgT1fYLu66xZhubSHPowXXO15
 LGDkROF0onqc8j4V29qy5iSnx8I9UIMEgrRpd6raJftlAeLXFa7BYlE2hf7cL+oG
 hY+q4S8CjHRuiDfebKFC1FJA3v3G9p9K4slrHlovxoVfe6QdduD8repoH07jWULu
 qQIDAQAB
 -----END PUBLIC KEY-----`
å­˜å‚¨ä¸ºpublic.txtã€‚æŠŠ mytest.jkså’Œpublic.txtæ”¾å…¥resourceç›®å½•ä¸‹

- è¿™é‡Œæˆ‘ä»¬è¦ä¿®æ”¹JwtAccessTokenConverterï¼ŒæŠŠè¯ä¹¦å¯¼å…¥

`       @Bean
         public TokenEnhancer accessTokenConverter() {
             final JwtAccessTokenConverter converter = new JwtAccessTokenConverter();
             KeyStoreKeyFactory keyStoreKeyFactory =
                     new KeyStoreKeyFactory(new ClassPathResource("mytest.jks"), "mypass".toCharArray());
             converter.setKeyPair(keyStoreKeyFactory.getKeyPair("mytest"));
             converter.setAccessTokenConverter(new CustomerAccessTokenConverter());
             return converter;
         }`
ä»¥ä¸Šï¼Œå°±å¯ä»¥å®ç°éå¯¹ç§°åŠ å¯†äº†

### é¢å¤–ä¿¡æ¯ï¼ˆè¿™éƒ¨åˆ†ä¿¡æ¯ä¸å…³ä¹åŠ å¯†æ–¹å¼ï¼‰

> è‡ªå®šä¹‰ç”Ÿæˆtokenæºå¸¦çš„ä¿¡æ¯

æœ‰æ—¶å€™éœ€è¦é¢å¤–çš„ä¿¡æ¯åŠ åˆ°tokenè¿”å›ä¸­ï¼Œè¿™éƒ¨åˆ†ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªTokenEnhancer 
TokenEnhancer æ¥å£æä¾›ä¸€ä¸ª enhance(OAuth2AccessToken var1, OAuth2Authentication var2) æ–¹æ³•ï¼Œç”¨äºå¯¹tokenä¿¡æ¯çš„æ·»åŠ ï¼Œä¿¡æ¯æ¥æºäº OAuth2Authentication

è¿™é‡Œæˆ‘ä»¬åŠ å…¥äº†ç”¨æˆ·çš„æˆæƒä¿¡æ¯ã€‚

`           @Override
             public OAuth2AccessToken enhance(OAuth2AccessToken accessToken, OAuth2Authentication authentication) {
                 final Map<String, Object> additionalInfo = new HashMap<>();
                 User user = (User) authentication.getUserAuthentication().getPrincipal();
                 additionalInfo.put("username", user.getUsername());
                 additionalInfo.put("authorities", user.getAuthorities());
                 ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(additionalInfo);
                 return accessToken;
             }`

åŒæ ·è¦å‘Šè¯‰spring securityï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªTokenEnhanceråŠ å…¥åˆ°TokenEnhanceré“¾ä¸­ï¼ˆé“¾ï¼Œæ‰€ä»¥å¯ä»¥å¥½å¤šä¸ªï¼‰

`       // è‡ªå®šä¹‰tokenç”Ÿæˆæ–¹å¼
         TokenEnhancerChain tokenEnhancerChain = new TokenEnhancerChain();
         tokenEnhancerChain.setTokenEnhancers(Arrays.asList(customerEnhancer(), accessTokenConverter()));
         endpoints.tokenEnhancer(tokenEnhancerChain);`

> è‡ªå®šä¹‰tokenä¿¡æ¯ä¸­æ·»åŠ çš„ä¿¡æ¯

JWTä¸­ï¼Œéœ€è¦åœ¨tokenä¸­æºå¸¦é¢å¤–çš„ä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥åœ¨æœåŠ¡ä¹‹é—´å…±äº«éƒ¨åˆ†ç”¨æˆ·ä¿¡æ¯ï¼Œspring securityé»˜è®¤åœ¨JWTçš„tokenä¸­åŠ å…¥äº†user_nameï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦é¢å¤–çš„ä¿¡æ¯ï¼Œéœ€è¦è‡ªå®šä¹‰è¿™éƒ¨åˆ†å†…å®¹ã€‚

JwtAccessTokenConverteræ˜¯æˆ‘ä»¬ç”¨æ¥ç”Ÿæˆtokençš„è½¬æ¢å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é…ç½®è¿™é‡Œé¢çš„éƒ¨åˆ†ä¿¡æ¯æ¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚ 
JwtAccessTokenConverteré»˜è®¤ä½¿ç”¨DefaultAccessTokenConverteræ¥å¤„ç†tokençš„ç”Ÿæˆã€è£…æ¢ã€è·å–ã€‚DefaultAccessTokenConverterä¸­ä½¿ç”¨UserAuthenticationConverteræ¥å¯¹åº”å¤„ç†tokenä¸userinfoçš„è·å–ã€è½¬æ¢ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦é‡å†™ä¸‹UserAuthenticationConverterå¯¹åº”çš„è½¬æ¢æ–¹æ³•å°±å¯ä»¥

`        @Override
         public Map<String, ?> convertUserAuthentication(Authentication authentication) {
             LinkedHashMap response = new LinkedHashMap();
             response.put("user_name", authentication.getName());
             response.put("name", ((User) authentication.getPrincipal()).getName());
             response.put("id", ((User) authentication.getPrincipal()).getId());
             response.put("createAt", ((User) authentication.getPrincipal()).getCreateAt());
             if (authentication.getAuthorities() != null && !authentication.getAuthorities().isEmpty()) {
                 response.put("authorities", AuthorityUtils.authorityListToSet(authentication.getAuthorities()));
             }
             return response;
         }`

å‘Šè¯‰JwtAccessTokenConverter ï¼ŒæŠŠæˆ‘ä»¬çš„æ–¹å¼æ›¿æ¢é»˜è®¤çš„æ–¹å¼

`       @Bean
         public TokenEnhancer accessTokenConverter() {
             final JwtAccessTokenConverter converter = new JwtAccessTokenConverter();
             converter.setSigningKey("123");
             converter.setAccessTokenConverter(new CustomerAccessTokenConverter());
             return converter;
         }`

### èµ„æºæœåŠ¡ç«¯

å®ç°æ–¹å¼ï¼Œä¸»è¦å¤å†™ResourceServerConfigurerAdapterå®ç°

#### èµ„æºæœåŠ¡1-å¯¹ç§°åŠ å¯†æ–¹å¼

æ­¤å¤„é…ç½®ä¸è®¤è¯æœåŠ¡åŸºæœ¬ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯ï¼Œèµ„æºæœåŠ¡å™¨é…ç½®æ˜¯åœ¨ResourceServerConfigurerAdapteråšé…ç½®ï¼Œå…¶ä»–çš„çœ‹æºç å§ï¼Œå¤§å·®ä¸å·®ã€‚

#### èµ„æºæœåŠ¡2-éå¯¹ç§°åŠ å¯†æ–¹å¼ï¼ˆå…¬é’¥ï¼‰

æŠŠ public.txtæ”¾å…¥resourceç›®å½•ä¸‹ 
ä¿®æ”¹JwtAccessTokenConverterå¦‚ä¸‹ï¼š

`        @Bean
         public JwtAccessTokenConverter accessTokenConverter() {
             JwtAccessTokenConverter converter = new JwtAccessTokenConverter();
             Resource resource = new ClassPathResource("public.txt");
             String publicKey = ;
             try {
                 publicKey = inputStream2String(resource.getInputStream());
             } catch (final IOException e) {
                 throw new RuntimeException(e);
             }
             converter.setVerifierKey(publicKey);
             converter.setAccessTokenConverter(new CustomerAccessTokenConverter());
             return converter;
         }`

ç„¶åå°±å¯ä»¥è·‘èµ·æ¥äº†ã€‚















